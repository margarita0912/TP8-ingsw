# ====== Stage 1: deps & build ======
FROM node:20-alpine AS build
WORKDIR /app

# Instalar deps con cache
COPY package*.json ./
RUN npm ci

# Copiar el c칩digo y buildear (Vite/CRA deja /dist)
COPY . .
# Si us치s Vite, este comando genera /dist
RUN npm run build

# ====== Stage 2: runtime (Alpine) ======
FROM node:20-alpine AS runner
WORKDIR /app

# Usuario no root
RUN addgroup -S web && adduser -S web -G web

# Instalar server est치tico
RUN npm i -g serve

# Copiar artefacto est치tico
COPY --from=build /app/dist /app/dist

# Railway/Render setean $PORT; por defecto 3000 local
ENV PORT=3000
EXPOSE 3000

USER web
ENTRYPOINT ["serve", "-s", "dist", "-l", "${PORT}"]
